<%- include('../partials/header') %>

    <div class="glass-panel">
        <h1><i class="fas fa-edit"></i> Gestione Risultati: <%= tournament.name %>
        </h1>
        <a href="/tournaments/<%= tournament.id %>" class="btn" style="margin-bottom: 20px;">&larr; Torna al Torneo</a>

        <% if (!tournament.matches || Object.keys(tournament.matches).length===0) { %>
            <p>Nessun match presente in questo torneo.</p>
            <% } else { %>
                <% Object.keys(tournament.matches).forEach(roundKey=> { %>
                    <% if (tournament.matches[roundKey]) { %>
                        <div
                            style="margin-bottom: 30px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">
                            <h3>
                                <%= roundKey.replace('_', ' ' ).toUpperCase() %>
                            </h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tavolo</th>
                                        <th>Giocatore 1</th>
                                        <th>Giocatore 2</th>
                                        <th>Risultato Attuale</th>
                                        <th>Modifica</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% tournament.matches[roundKey].forEach((m, idx)=> { %>
                                        <tr>
                                            <td>
                                                <%= m.table %>
                                            </td>
                                            <td>
                                                <%= usersMap[m.player1] ? usersMap[m.player1].username : 'BYE' %>
                                            </td>
                                            <td>
                                                <%= m.player2 ? (usersMap[m.player2] ? usersMap[m.player2].username
                                                    : 'BYE' ) : 'N/A' %>
                                            </td>
                                            <td>
                                                <% if (m.winner) { %>
                                                    <%= m.score1 %> - <%= m.score2 %>
                                                            (<%= m.winner==='draw' ? 'Pareggio' : 'Vince ' +
                                                                (usersMap[m.winner] ? usersMap[m.winner].username :
                                                                m.winner) %>)
                                                                <% } else { %>
                                                                    In Corso
                                                                    <% } %>
                                            </td>
                                            <td>
                                                <% if (m.player2) { %>
                                                    <form action="/admin/matches/update" method="POST"
                                                        style="display: flex; gap: 5px; align-items: center;">
                                                        <input type="hidden" name="tournamentId"
                                                            value="<%= tournament.id %>">
                                                        <input type="hidden" name="roundKey" value="<%= roundKey %>">
                                                        <input type="hidden" name="matchIndex" value="<%= idx %>">

                                                        <input type="number" name="score1" placeholder="S1"
                                                            style="width: 50px;"
                                                            value="<%= m.score1 !== null ? m.score1 : 0 %>" required>
                                                        <input type="number" name="score2" placeholder="S2"
                                                            style="width: 50px;"
                                                            value="<%= m.score2 !== null ? m.score2 : 0 %>" required>

                                                        <button class="btn btn-primary"
                                                            style="padding: 5px 10px;">Salva</button>
                                                    </form>
                                                    <% } else { %>
                                                        BYE (Non modificabile)
                                                        <% } %>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>
                        <% } else { %>
                            <div class="alert" style="background: rgba(255,0,0,0.2); color: red;">
                                Errore: Il round <%= roundKey %> non ha abbinamenti validi (NULL). Probabile errore di
                                    generazione.
                            </div>
                            <% } %>
                                <% }) %>
                                    <% } %>

                                        <!-- SEZIONE PENALITÀ -->
                                        <div
                                            style="margin-top: 40px; background: rgba(255, 165, 0, 0.1); padding: 20px; border-radius: 10px; border: 2px solid rgba(255, 165, 0, 0.3);">
                                            <h2><i class="fas fa-exclamation-triangle"></i> Gestione Penalità (Malus)
                                            </h2>
                                            <p style="color: rgba(255, 165, 0, 0.9);">Le penalità influenzano la
                                                classifica: a parità di punti, vince chi ha MENO malus.</p>

                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Giocatore</th>
                                                        <th>Punti Attuali</th>
                                                        <th>Malus Attuali</th>
                                                        <th>Modifica Malus</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% tournament.participants.forEach(p=> { %>
                                                        <tr>
                                                            <td>
                                                                <div
                                                                    style="display: flex; align-items: center; gap: 10px;">
                                                                    <img src="/<%= usersMap[p.userId]?.avatar || 'img/default_avatar.png' %>"
                                                                        class="avatar"
                                                                        style="width: 30px; height: 30px;">
                                                                    <%= usersMap[p.userId]?.username || 'Player ' +
                                                                        p.userId %>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <%= p.score || 0 %> pts
                                                            </td>
                                                            <td>
                                                                <span
                                                                    style="color: <%= (p.malus || 0) > 0 ? 'orange' : 'inherit' %>; font-weight: bold;">
                                                                    <%= p.malus || 0 %>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <form
                                                                    action="/admin/tournaments/<%= tournament.id %>/penalty"
                                                                    method="POST"
                                                                    style="display: flex; gap: 10px; align-items: center;">
                                                                    <input type="hidden" name="userId"
                                                                        value="<%= p.userId %>">
                                                                    <input type="number" name="malus"
                                                                        value="<%= p.malus || 0 %>" min="0" max="99"
                                                                        style="width: 70px;">
                                                                    <button class="btn btn-primary"
                                                                        style="padding: 5px 15px;">
                                                                        <i class="fas fa-save"></i> Aggiorna
                                                                    </button>
                                                                </form>
                                                            </td>
                                                        </tr>
                                                        <% }) %>
                                                </tbody>
                                            </table>

                                            <div class="alert"
                                                style="background: rgba(0,150,255,0.1); margin-top: 15px;">
                                                <i class="fas fa-info-circle"></i> <strong>Nota:</strong> I malus
                                                vengono usati come tie-breaker.
                                                A parità di punti, il giocatore con MENO malus sarà più in alto in
                                                classifica.
                                            </div>
                                        </div>
    </div>

    <%- include('../partials/footer') %>